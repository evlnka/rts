# Инверсия приоритетов

- Ситуация: высокий приоритет (H) ждёт мьютекс у низкого (L), а средний (M) вытесняет L, увеличивая задержку H.
- Эффект — временная «инверсия» порядка выполнения.

## Диаграмма

- t=0: L захватывает мьютекс и входит в длинную критическую секцию.
- t=1: H пытается захватить мьютекс — блокируется.
- t=2: планировщик запускает M (не зависит от мьютекса), L вытесняется -> H ждёт, пока M занят.

## Протоколы

- Inheritance (PTHREAD_PRIO_INHERIT): при блокировке H на мьютексе L временно получает приоритет H, завершая критическую секцию быстрее.
- Ceiling (PTHREAD_PRIO_PROTECT): у мьютекса фиксированный "потолок" — поток при захвате получает этот приоритет, предотвращая вытеснение.

## Практика и ограничения

- На Linux требуется поддержка ядра/библиотеки для `PTHREAD_PRIO_INHERIT/PROTECT`. Не все конфигурации их включают.
- Настроить права/капабилити для использования `SCHED_FIFO/RR`.
- Критические секции должны быть короткими; избегайте I/O и сна под мьютексом.

Практика:

- `scenario_1.c` — демонстрация инверсии приоритетов на SCHED_FIFO без наследования.

Здесь используется обычный мьютекс без наследования приоритета что вызывает проблему инверсии приоритетов. Высокоприоритетный поток t2 блокируется на мьютексе а средний приоритет t1 выполняется вместо SERVER. Это приводит к тому что t2 долго ждет пока завершатся и SERVER и t1 что нарушает требования реального времени.

Вывод:
[![scenario1.png](https://i.postimg.cc/mZcwXGgR/scenario1.png)](https://postimg.cc/DmTL0HGY)

- `scenario_2.c` — выполнить студенту: включить наследование/ceiling и сравнить задержку.

Здесь эта проблема решается включением наследования приоритета для мьютекса. Когда t2 блокируется система временно повышает приоритет SERVER до уровня t2. Теперь t1 не может прервать SERVER SERVER быстро завершает работу и освобождает ресурс а t2 сразу получает мьютекс. Инверсия приоритетов устранена и высокоприоритетная задача выполняется без задержек.

[![scenario2.png](https://i.postimg.cc/ydpLJ16T/scenario2.png)](https://postimg.cc/N9T6SwHy)

